<?php# МОДУЛЬ ИСТОРИЯ ДЕЙСТВИЙ v.2.0# Coded by ShadoW (с) 2013class cnt_Index extends Controller{	private $_actions 	= false;	private $_users   	= false;	private $_perpages  = false;	private $_date1		= false;	private $_date2		= false;	private	$_action	= false;	private	$_user_id	= false;	private $_onpage  	= 50;	# ИНИЦИАЛИЗАЦИЯ	public function init()	{		# Проверка авторизации		if (!Core::$_data['authed']) Helpers::redirect(_CMS_.'auth');		# Действия		$this->_actions = array(			1 => array('id'=>1, 'name'=>'добавил', 	'color'=>'green'),			2 => array('id'=>2, 'name'=>'изменил', 	'color'=>'blue'),			3 => array('id'=>3, 'name'=>'удалил', 	'color'=>'red'),			4 => array('id'=>4, 'name'=>'включил', 	'color'=>'orange'),			5 => array('id'=>5, 'name'=>'отключил',	'color'=>'#F47575'),		);		# Пользователи		if ($users = Model::$_db->select('md_users', "ORDER BY `id` ASC", "`id`, `name`"))		{			foreach($users as $u) $this->_users[$u['id']] = $u;		}		# Записей на страницу		$this->_perpages = array(			50	 => array('set'=>false),			100	 => array('set'=>false),			500	 => array('set'=>false),			1000 => array('set'=>false)		);		# Даты		if (isset($_GET['date1']) && preg_match('/^\d{2}\.\d{2}\.\d{4}$/', $_GET['date1'])) $this->_date1 = $_GET['date1'];		if (isset($_GET['date2']) && preg_match('/^\d{2}\.\d{2}\.\d{4}$/', $_GET['date2'])) $this->_date2 = $_GET['date2'];		# Действие		if (isset($_GET['action']) && ($action = filter_input(INPUT_GET, 'action', FILTER_VALIDATE_INT)) && isset($this->_actions[$action]))	$this->_action = $action;		# Пользователь		if (isset($_GET['user_id']) && ($user_id = filter_input(INPUT_GET, 'user_id', FILTER_VALIDATE_INT)) && isset($this->_users[$user_id]))	$this->_user_id = $user_id;		# На страницу		if (isset($_GET['onpage']) && ($onpage = filter_input(INPUT_GET, 'onpage', FILTER_VALIDATE_INT)) && isset($this->_perpages[$onpage]))		{			$this->_perpages[$onpage]['set'] = true;			$this->_onpage = $onpage;		}	}	# ИСТОРИЯ ДЕЙСТВИЙ	public function act_index()	{		# Получаем логи		if ($logs = Logger::get($this->_onpage, $this->_date1, $this->_date2, $this->_action, $this->_user_id))		{			foreach($logs as $k=>$l)			{				$logs[$k] = $l;				$logs[$k]['date'] 	= date('d.m.Y в H:i', $logs[$k]['date']);				$logs[$k]['user'] 	= $logs[$k]['user_name'];				$logs[$k]['action'] = (isset($this->_actions[$logs[$k]['action']]) && ($action = $this->_actions[$logs[$k]['action']]) ? '<div style="color:'.$action['color'].';">'.$action['name'].'</div>' : '<span>неизвестно</spa>');				$logs[$k]['object'] = filter_var($logs[$k]['object_id'], FILTER_VALIDATE_INT)	? '<a href="'._MODULES_.'objects/edit/'.$logs[$k]['object_id'].'">'.$logs[$k]['object_name'].'</a>' : $logs[$k]['object_name'];				$logs[$k]['class']  = filter_var($logs[$k]['class_id'], FILTER_VALIDATE_INT)	? '<a href="'._MODULES_.'templates/edit/'.$logs[$k]['class_id'].'">'.$logs[$k]['class_name'].'</a>' : $logs[$k]['class_name'];			}			unset($k, $l);		}		# ВЫВОД		View::assign('%page_title', 'История действий');		View::render('modules/logs/list', true, array(			'date1'		=> $this->_date1,			'date2'		=> $this->_date2,			'actions'	=> $this->_actions,			'action'	=> $this->_action,			'users'		=> $this->_users,			'user_id'	=> $this->_user_id,			'perpages'	=> $this->_perpages,			'logs'		=> $logs		));	}	# ОЧИСТКА ИСТОРИИ	public function act_clear()	{		View::assign('%page_title', 'Очистка истории');		if (isset($this->_params[0]) && ($this->_params[0] == 'yes'))		{			Logger::clear();			View::render('modules/logs/cleared');		}		else View::render('modules/logs/confirm_clear');	}}