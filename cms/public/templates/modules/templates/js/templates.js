const _AJAX_			= '/cms/modules/templates/ajax/a/';const _CONNECT_ERROR_	= 'Невозможно связаться с сервером';// DOM$(function(){	// Смена типа шаблона	$('.template_additional').click(function()	{		$('#infobox').hide().removeClass('errorbox').empty();		// Доп.шаброн		if ($(this).val() == 1)		{			var addtemplate_fields_found = false;			$('#template_fields .temlate_field').each(function(key, obj)			{				if ($(obj).find('.t_type').attr('alt') == 'template')				{					addtemplate_fields_found = true;					$(obj).addClass('error');				}			});			if (addtemplate_fields_found) $('#infobox').addClass('errorbox').text('Дополнительный шаблон не должен содержать поля доп.шаблонов').fadeIn();		}		// Обычный шаблон		else		{			$('#template_fields .temlate_field').each(function(key, obj)			{				if ($(obj).find('.t_type').attr('alt') == 'template') $(obj).removeClass('error');			});		}	});	// Смена типа поля	$('#field_type').change(function()	{		var field_id = $(this).val();		$('#field_conf_status').hide().removeClass('error').empty();		$('#template_field_form .template_field_config').hide();		$('#fild_image_cfg checkbox').prop('checked', false);		$('#template_field_form .field_cfg').val('').each(function()		{			if ($(this).attr('title') != '') $(this).val($(this).attr('title'));		});		if (field_id != '') $('#field_'+field_id).slideDown('fast');	});	// Ввод связи	$('#field_link .field_cfg, #field_multi-link .field_cfg').keyup(function()	{		$(this).removeClass('ok');		$('#field_conf_status').hide().removeClass('error').empty();		digInput($(this));	});	// Проверка связи	$('#field_link_checkbtn').click(function()	{		var link_id = $('#field_link .field_cfg').val();		if (link_id != '')		{			$('#field_conf_status').removeClass('error').text('Проверка связи...').fadeIn('fast');			$.getJSON(_AJAX_+'getlink/'+link_id, function(json)			{				if (typeof json == 'object')				{					if (json.status == 'ok')					{						$('#field_link .field_cfg').addClass('ok');						$('#field_conf_status').html('<span class="ok">Связь найдена <a href="/cms/modules/objects/s/'+json.id+'" target="_blank">'+json.name+'</a></span>').fadeIn('fast');					}					else $('#field_conf_status').addClass('error').text(json.msg).fadeIn('fast');				}				else $('#field_conf_status').addClass('error').text(_CONNECT_ERROR_).fadeIn('fast');			});		}		else		{			$('#field_conf_status').addClass('error').text('Укажите ID объекта для связи').fadeIn('fast');			$('#field_link .field_cfg').focus();		}	});	// Проверка мульти-связи	$('#field_multi-link_checkbtn').click(function()	{		var link_id = $("#field_multi-link .field_cfg").val();		if (link_id != '')		{			$('#field_conf_status').removeClass('error').text('Проверка связи...').fadeIn('fast');			$.getJSON(_AJAX_+'getlink/'+link_id, function(json)			{				if (typeof json == 'object')				{					if (json.status == 'ok')					{						$('#field_multi-link .field_cfg').addClass('ok');						$('#field_conf_status').html('<span class="ok">Связь найдена <a href="/cms/modules/objects/s/'+json.id+'" target="_blank">'+json.name+'</a></span>').fadeIn('fast');					}					else $('#field_conf_status').addClass('error').text(json.msg).fadeIn('fast');				}				else $('#field_conf_status').addClass('error').text(_CONNECT_ERROR_).fadeIn('fast');			});		}		else		{			$('#field_conf_status').addClass('error').text('Укажите ID объекта для связи').fadeIn('fast');			$('#field_multi-link .field_cfg').focus();		}	});	// Добавление поля	$('#add_field').click(function()	{		$('#template_field_form').dialog(		{			title		: 'Добавление поля',			width		: 400,			modal		: true,			resizable	: false,			open 		: function()			{				// Сбрасываем поля				$('#field_name').val('');				$('#field_type').find('option:first').prop('selected', true).parent().change();			},			close		: function()			{				$(this).dialog('destroy');			},			buttons :			{				'Добавить поле' : function()				{					var error 		= '';					var atribute 	= '';					var name_found 	= false;					$('#field_conf_status').hide().removeClass('error').empty();					$('#template_fields .temlate_field').each(function()					{						if ($(this).find('.t_name').text() == $('#field_name').val()) name_found = true;					});					if ($('#field_name').val() == '')					{						error = 'Укажите название поля';						$('#field_name').focus();					}					else if (name_found)					{						error = 'Поле с таким названием уже есть';						$('#field_name').focus();					}					else if ($('#field_type').val() == '')					{						error = 'Укажите тип поля';						$('#field_type').focus();					}					else					{						switch ($('#field_type').val())						{							case 'radio':								if ($('#field_radio .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_radio .field_cfg').focus();								}							break;							case 'select':								if ($('#field_select .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_select .field_cfg').focus();								}							break;							case 'multi-select':								if ($('#field_multi-select .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_multi-select .field_cfg').focus();								}							break;							case 'link':								if (($('#field_link .field_cfg').val() == '') || (!$('#field_link .field_cfg').hasClass('ok')))								{									error = 'Проверьте связь с объектом';									$('#field_link .field_cfg').focus();								}							break;							case 'multi-link':								if (($('#field_multi-link .field_cfg').val() == '') || (!$('#field_multi-link .field_cfg').hasClass('ok')))								{									error = 'Проверьте связь с объектом';									$('#field_multi-link .field_cfg').focus();								}							break;							case 'multi-val':							if (($('#field_multi-val .field_cfg').val() == '') || ($('#field_multi-val .field_cfg').hasClass('ok') == false))							{								error = 'Проверьте связь с объектом';								$('#field_multi-val .field_cfg').focus();							}							break;							case 'file':								if ($('#field_file .field_cfg').val() == '')								{									error = 'Укажите хотябы один тип файла';									$('#field_file .field_cfg').focus();								}							break;							case 'template':								if ($('.template_additional:checked').val() == 1)								{									error = 'Недопустимый тип поля';								}							break;						}					}					if (error == '')					{						$('#template_nofields').hide();						switch ($('#field_type').val())						{							case 'radio':								atribute = $('#field_radio .field_cfg').val();							break;							case 'select':								atribute = $('#field_select .field_cfg').val();							break;							case 'multi-se;lect':								atribute = $('#field_multi-select .field_cfg').val();							break;							case 'link':								atribute = $('#field_link .field_cfg').val();							break;							case 'multi-link':								atribute = $('#field_multi-link .field_cfg').val();							break;							case 'multi-val':								atribute = $('#field_multi-val .field_cfg').val();							break;							case 'image':								var image_w = '';								var image_h = '';								if								(									($('#fild_image_cfg .fild_image_w input[type="checkbox"]').is(':checked')) &&									($('#fild_image_cfg .fild_image_w .field_cfg').val() != '')								) image_w = $('#fild_image_cfg .fild_image_w .field_cfg').val();								if								(									($('#fild_image_cfg .fild_image_h input[type="checkbox"]').is(':checked')) &&									($('#fild_image_cfg .fild_image_h .field_cfg').val() != '')								) image_h = $('#fild_image_cfg .fild_image_h .field_cfg').val();								if ((image_w != '') || (image_h != '')) atribute = image_w+'x'+image_h;							break;							case 'file':								atribute = $('#field_file .field_cfg').val();							break;							case 'password':								atribute = $('#field_password .field_cfg').val();							break;						}						$('#template_fields').append('<tr class="temlate_field"><td align="right"></td><td class="t_type" alt="'+$('#field_type').val()+'" align="center">'+$('#field_type').val()+'<textarea class="atribute hidden">'+atribute+'</textarea></td><td class="t_name">'+$('#field_name').val()+'</td><td align="center"><a class="edit" href="#" title="Редактировать поле"><img src="/cms/images/edit.png"></a> &nbsp;<a class="remove" href="#" title="Удалить поле"><img src="/cms/images/del.png" /></a></td></tr>');						$('#infobox').hide().removeClass('error').empty();						$('#template_field_form').dialog('close');					}					else $('#field_conf_status').addClass('error').text(error).fadeIn('fast');				},				'Отмена' : function() {	$(this).dialog('destroy'); }			}		});		return false;	});	// Редактирование поля	$('#template_fields').on('click', '.edit', function()	{		var $container = $(this).parent().parent();		$container.addClass('set');		$('#template_field_form').dialog(		{			title		: 'Редактировние поля',			width		: 400,			modal		: true,			resizable	: false,			open 		: function()			{				var field_name	= $container.find('.t_name').text();				var field_type	= $container.find('.t_type').attr('alt');				var atribute	= $container.find('.t_type .atribute').val();				$('#field_name').val(field_name);				$('#field_type option[value="'+field_type+'"]').prop('selected', true).parent().change();				switch (field_type)				{					case 'radio':						$('#field_radio .field_cfg').val(atribute);					break					case 'select':						$('#field_select .field_cfg').val(atribute);					break					case 'multi-select':						$('#field_multi-select .field_cfg').val(atribute);					break					case 'link':						$('#field_link .field_cfg').val(atribute);					break					case 'multi-link':						$('#field_multi-link .field_cfg').val(atribute);					break					case 'image':						if (atribute.length >= 3)						{							image_params = atribute.split('x');							if (image_params[0] != '')							{								$('#fild_image_cfg .fild_image_w input[type="checkbox"]').prop('checked', true);								$('#fild_image_cfg .fild_image_w .field_cfg').val(image_params[0]);							}							else $('#fild_image_cfg .fild_image_w input[type="checkbox"]').prop('checked', false);							if (image_params[1] != '')							{								$('#fild_image_cfg .fild_image_h input[type="checkbox"]').prop('checked', true);								$('#fild_image_cfg .fild_image_h .field_cfg').val(image_params[1]);							}							else $('#fild_image_cfg .fild_image_h input[type="checkbox"]').prop('checked', false);						}					break					case 'file':						$('#field_file .field_cfg').val(atribute);					break					case 'password':						$('#field_password .field_cfg').val(atribute);					break				}			},			close : function()			{				$container.removeClass('set');				$(this).dialog('destroy');			},			buttons :			{				'Сохранить поле' : function()				{					var error 		= '';					var atribute 	= '';					var name_found 	= false;					$('#field_conf_status').hide().removeClass('error').empty();					$('#template_fields .temlate_field').each(function()					{						if (!$(this).hasClass('set') && ($(this).find('.t_name').text() == $('#field_name').val())) name_found = true;					});					if ($('#field_name').val() == '')					{						error = 'Укажите название поля';						$('#field_name').focus();					}					else if (name_found)					{						error = 'В шаблоне уже есть поле с таким названием';						$('#field_name').focus();					}					else if ($('#field_type').val() == '')					{						error = 'Укажите тип поля';						$('#field_type').focus();					}					else					{						switch ($('#field_type').val())						{							case 'radio':								if ($('#field_radio .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_radio .field_cfg').focus();								}							break							case 'select':								if ($('#field_select .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_select .field_cfg').focus();								}							break							case 'multi-select':								if ($('#field_multi-select .field_cfg').val() == '')								{									error = 'Укажите варианты выбора';									$('#field_multi-select .field_cfg').focus();								}							break							case 'link':								if (($('#field_link .field_cfg').val() == '') || ($('#field_link .field_cfg').hasClass('ok') == false))								{									error = 'Проверьте связь с объектом';									$('#field_link .field_cfg').focus();								}							break							case 'multi-link':								if (($('#field_multi-link .field_cfg').val() == '') || ($('#field_multi-link .field_cfg').hasClass('ok') == false))								{									error = 'Проверьте связь с объектом';									$('#field_multi-link .field_cfg').focus();								}							break							case 'file':								if ($('#field_file .field_cfg').val() == '')								{									error = 'Укажите хотябы один тип файла';									$('#field_file .field_cfg').focus();								}							break							case 'template':								if ($('.template_additional:checked').val() == 1)								{									error = 'Недопустимый тип поля';								}							break;						}					}					if (error == '')					{						switch ($('#field_type').val())						{							case 'radio':								atribute = $('#field_radio .field_cfg').val();							break							case 'select':								atribute = $('#field_select .field_cfg').val();							break							case 'multi-select':								atribute = $('#field_multi-select .field_cfg').val();							break							case 'link':								atribute = $('#field_link .field_cfg').val();							break							case 'multi-link':								atribute = $('#field_multi-link .field_cfg').val();							break							case 'image':								var image_w = '';								var image_h = '';								if								(									($('#fild_image_cfg .fild_image_w input[type="checkbox"]').is(':checked') == true) && ($('#fild_image_cfg .fild_image_w .field_cfg').val() != '')								) image_w = $('#fild_image_cfg .fild_image_w .field_cfg').val();								if								(									($('#fild_image_cfg .fild_image_h input[type="checkbox"]').is(':checked') == true) && ($('#fild_image_cfg .fild_image_h .field_cfg').val() != '')								) image_h = $('#fild_image_cfg .fild_image_h .field_cfg').val();								if ((image_w != '') || (image_h != '')) atribute = image_w+'x'+image_h;							break							case 'file':								atribute = $('#field_file .field_cfg').val();							break							case 'password':								atribute = $('#field_password .field_cfg').val();							break						}						$container							.removeClass('error')							.find('.t_type').attr('alt', $('#field_type').val()).html($('#field_type').val()+'<textarea class="atribute hidden">'+atribute+'</textarea>')							.parent()							.find('.t_name').text($('#field_name').val());						$('#infobox').hide().removeClass('errorbox').empty();						$('#template_field_form').dialog('close');					}					else $("#field_conf_status").addClass('error').text(error).fadeIn('fast');				},				'Отмена': function() {	$(this).dialog('close'); }			}		});		return false;	});	// Удаление поля	$('#template_fields').on('click', '.remove', function()	{		if (confirm('Удалить поле?'))		{			$('#infobox').hide().removeClass('errorbox').empty();			$(this).parent().parent().remove();			if ($('#template_fields tr').length == 2) $('#template_nofields').show();		}		return false;	});	// Сортировка полей	$('.sortable').sortable(	{		containment	: 'parent',		items		: 'tbody tr',		axis		: 'y',		tolerance	: 'pointer',		distance	: 10,		delay		: 200,		cursor		: 'move',		opacity		: 0.6	});	// Добавление шаблона	$('#template_add').submit(function()	{		var error	= '';		var fields	= {};		$('#infobox').hide().removeClass('errorbox').empty();		$('#template_add_btn').prop('disabled', true);		if ($('#template_name').val() == '')		{			error = 'Введите название наблона';			$('#template_name').focus();		}		if ($('#template_fields .temlate_field').length == 0)		{			error = $('#template_nofields .error').text();		}		else		{			// Поля шаблона			var template_fields_found = false;			$('#template_fields .temlate_field').each(function(key, obj)			{				fields[key] =				{					name	 : $(obj).find('.t_name').text(),					type 	 : $(obj).find('.t_type').attr('alt'),					atribute : $(obj).find('.t_type .atribute').val()				}				// Проверям доп шаблоны				if ((fields[key].type == 'template') && ($('#template_add .template_additional:checked').val() == 1))				{					$(obj).addClass('error');					template_fields_found = true;				}			});			if (template_fields_found) error = error+'Дополнительный шаблон не должен содержать поля доп.шаблонов';		}		if (error == '')		{			// POST			$.post(_AJAX_+'add',			{				additional 	: $('.template_additional:checked').val(),				name 		: $('#template_name').val(),				desc		: $('#template_desc').val(),				fields		: fields			},			function(json)			{				if (typeof json == 'object')				{					if (json.status == 'ok') top.location = '/cms/modules/templates/';					else $('#infobox').addClass('errorbox').text(json.msg).fadeIn();				}				else $('#infobox').addClass('errorbox').text(_CONNECT_ERROR_).fadeIn();			}, 'json');		}		else $('#infobox').addClass('errorbox').text(error).fadeIn();		$('#template_add_btn').prop('disabled', false);		return false;	});	// Редактирование шаблона	$('#template_edit').submit(function()	{		var error	= '';		var fields	= {};		$('#infobox').hide().removeClass('errorbox').empty();		$('#template_edit_btn').prop('disabled', true);		if ($('#template_name').val() == '')		{			error = 'Введите название наблона';			$('#template_name').focus();		}		if ($('#template_fields .temlate_field').length == 0)		{			error = $('#template_nofields .error').text();		}		else		{			// Поля шаблона			var template_fields_found = false;			$('#template_fields .temlate_field').each(function(key, obj)			{				fields[key] =				{					id		 : $(obj).find('.t_id').text(),					name	 : $(obj).find('.t_name').text(),					type 	 : $(obj).find('.t_type').attr('alt'),					atribute : $(obj).find('.t_type .atribute').val()				}				// Проверям доп шаблоны				if ((fields[key].type == 'template') && ($('#template_edit .template_additional:checked').val() == 1))				{					$(obj).addClass('error');					template_fields_found = true;				}			});			if (template_fields_found) error = 'Дополнительный шаблон не должен содержать поля доп.шаблонов';		}		if (error == '')		{			// POST			$.post(_AJAX_+'edit',			{				id			: $('#template_id').val(),				additional 	: $('.template_additional:checked').val(),				name		: $('#template_name').val(),				desc		: $('#template_desc').val(),				fields		: fields			},			function(json)			{				if (typeof json == 'object')				{					if (json.status == 'ok') top.location = '/cms/modules/templates/';					else $('#infobox').addClass('errorbox').text(json.msg).fadeIn();				}				else $('#infobox').addClass('errorbox').text(_CONNECT_ERROR_).fadeIn();			}, 'json');		}		else $('#infobox').addClass('errorbox').text(error).fadeIn();		$('#template_edit_btn').prop('disabled', false);		return false;	});	// Удаление шаблона	$('#templates_list .remove_template').click(function()	{		if (confirm('Удалить шаблон?'))		{			var $obj = $(this).parent().parent();			$.getJSON(_AJAX_+'remove/'+$obj.data('id'), function(json)			{				if (typeof json == 'object')				{					if (json.status == 'ok') $obj.fadeOut(500, function() { $(this).remove(); });					else error_alert(json.msg);				}				else error_alert(_CONNECT_ERROR_);			});		}		return false;	});});